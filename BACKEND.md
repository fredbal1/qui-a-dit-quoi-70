
# BACKEND - Documentation d√©taill√©e

## Vue d'ensemble
Cette documentation d√©taille chaque table Supabase, ses colonnes, et les √©l√©ments frontend qui les utilisent.

---

## üîê Authentification et profils

### 1. **Table `auth.users`** (Supabase natif)
- **Gestion**: Automatique par Supabase Auth
- **Colonnes principales**:
  - `id` (uuid) ‚Üí R√©f√©rence dans toutes les autres tables
  - `email` ‚Üí Input email (page Auth)
  - `encrypted_password` ‚Üí Input password (page Auth)
  - `raw_user_meta_data` ‚Üí M√©tadonn√©es (pseudo, avatar)
- **√âl√©ments frontend connect√©s**:
  - Page Auth : inputs email/password
  - Hook `useAuth` : gestion des sessions
- **RLS**: G√©r√© automatiquement par Supabase

### 2. **Table `profiles`**
```sql
CREATE TABLE profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id),
  pseudo text NOT NULL,
  email text,
  avatar text DEFAULT 'üéÆ',
  created_at timestamp DEFAULT now()
);
```
- **Colonnes et connexions frontend**:
  - `id` ‚Üí ID utilisateur (automatique)
  - `pseudo` ‚Üí Input pseudo (page Auth, Dashboard)
  - `email` ‚Üí Email affich√© (Dashboard)
  - `avatar` ‚Üí Avatar affich√© (Dashboard, Lobby)
  - `created_at` ‚Üí Date d'inscription
- **√âl√©ments frontend connect√©s**:
  - Page Auth : cr√©ation du profil
  - Dashboard : affichage du pseudo et avatar
  - Lobby : liste des joueurs
- **RLS**: ‚úÖ Configur√©
  - Lecture : tous les utilisateurs authentifi√©s
  - √âcriture : propri√©taire uniquement

### 3. **Table `user_stats`**
```sql
CREATE TABLE user_stats (
  user_id uuid PRIMARY KEY REFERENCES auth.users(id),
  level integer DEFAULT 1,
  total_xp integer DEFAULT 0,
  coins integer DEFAULT 0,
  games_played integer DEFAULT 0,
  games_won integer DEFAULT 0,
  best_streak integer DEFAULT 0,
  bluffs_successful integer DEFAULT 0,
  bluffs_detected integer DEFAULT 0,
  achievements text[] DEFAULT '{}',
  titles text[] DEFAULT '{}'
);
```
- **Colonnes et connexions frontend**:
  - `user_id` ‚Üí R√©f√©rence utilisateur
  - `level` ‚Üí Badge level (Dashboard)
  - `total_xp` ‚Üí Barre d'XP (Dashboard)
  - `coins` ‚Üí Solde coins (Dashboard, Shop)
  - `games_played` ‚Üí Stat parties jou√©es (Dashboard)
  - `games_won` ‚Üí Stat parties gagn√©es (Dashboard)
  - `best_streak` ‚Üí Meilleure s√©rie (Dashboard)
  - `bluffs_successful` ‚Üí Bluffs r√©ussis (Dashboard)
  - `bluffs_detected` ‚Üí Bluffs d√©tect√©s (Dashboard)
  - `achievements` ‚Üí Liste des achievements (Dashboard)
  - `titles` ‚Üí Titres d√©bloqu√©s (Shop)
- **√âl√©ments frontend connect√©s**:
  - Hook `usePlayerStats`
  - Dashboard : section statistiques compl√®te
- **RLS**: ‚úÖ Configur√©
  - Lecture/√âcriture : propri√©taire uniquement

---

## üéÆ Gestion des parties

### 4. **Table `games`**
```sql
CREATE TABLE games (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  code varchar(6) UNIQUE NOT NULL,
  host uuid REFERENCES auth.users(id),
  status text DEFAULT 'waiting',
  phase text DEFAULT 'intro',
  current_round integer DEFAULT 1,
  total_rounds integer DEFAULT 5,
  current_game text,
  settings jsonb NOT NULL,
  created_at timestamp DEFAULT now()
);
```
- **Colonnes et connexions frontend**:
  - `id` ‚Üí ID unique de la partie
  - `code` ‚Üí Code de la partie (CreateGame, JoinGame, Lobby)
  - `host` ‚Üí ID de l'h√¥te (permissions sp√©ciales)
  - `status` ‚Üí 'waiting', 'playing', 'finished' (Lobby, Game)
  - `phase` ‚Üí 'intro', 'answer', 'vote', 'reveal', 'results' (Game)
  - `current_round` ‚Üí Round actuel (Game)
  - `total_rounds` ‚Üí Nombre total de rounds (CreateGame, Game)
  - `current_game` ‚Üí Mini-jeu actuel (Game)
  - `settings` ‚Üí Configuration JSON (CreateGame, Lobby)
    - `settings.mode` ‚Üí Mode de jeu
    - `settings.ambiance` ‚Üí Ambiance s√©lectionn√©e
    - `settings.miniGames` ‚Üí Liste des mini-jeux
    - `settings.twoPlayersOnly` ‚Üí Mode 2 joueurs
- **√âl√©ments frontend connect√©s**:
  - CreateGame : cr√©ation avec settings
  - JoinGame : recherche par code
  - Lobby : affichage des param√®tres
  - Game : gestion des phases et rounds
- **RLS**: ‚úÖ Configur√©
  - Lecture : participants uniquement
  - Cr√©ation : utilisateur authentifi√©
  - Modification : h√¥te uniquement

### 5. **Table `game_players`**
```sql
CREATE TABLE game_players (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  game_id uuid REFERENCES games(id),
  user_id uuid REFERENCES auth.users(id),
  is_host boolean DEFAULT false,
  score integer DEFAULT 0,
  level integer DEFAULT 1,
  xp integer DEFAULT 0,
  coins integer DEFAULT 0
);
```
- **Colonnes et connexions frontend**:
  - `id` ‚Üí ID unique du joueur dans la partie
  - `game_id` ‚Üí R√©f√©rence √† la partie
  - `user_id` ‚Üí R√©f√©rence au joueur
  - `is_host` ‚Üí Statut h√¥te (permissions interface)
  - `score` ‚Üí Score actuel (Game, scoreboard)
  - `level` ‚Üí Level du joueur (affichage)
  - `xp` ‚Üí XP du joueur (affichage)
  - `coins` ‚Üí Coins du joueur (affichage)
- **√âl√©ments frontend connect√©s**:
  - Lobby : liste des joueurs connect√©s
  - Game : scores en temps r√©el
  - Hook `useCurrentPlayer`
- **RLS**: ‚úÖ Configur√©
  - Lecture/√âcriture : propri√©taire uniquement

---

## üéØ Gameplay

### 6. **Table `rounds`**
```sql
CREATE TABLE rounds (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  game_id uuid REFERENCES games(id),
  round_number integer NOT NULL,
  mini_game_id text NOT NULL,
  question_id text REFERENCES questions(id),
  status text DEFAULT 'waiting',
  started_at timestamp,
  completed_at timestamp
);
```
- **Colonnes et connexions frontend**:
  - `id` ‚Üí ID unique du round
  - `game_id` ‚Üí R√©f√©rence √† la partie
  - `round_number` ‚Üí Num√©ro du round (Game header)
  - `mini_game_id` ‚Üí Type de mini-jeu (Game interface)
  - `question_id` ‚Üí Question √† afficher
  - `status` ‚Üí Statut du round
  - `started_at` ‚Üí Heure de d√©but
  - `completed_at` ‚Üí Heure de fin
- **√âl√©ments frontend connect√©s**:
  - Game : composants de mini-jeux
  - Hook `useRoundManagement`
- **RLS**: ‚úÖ Configur√©
  - Lecture : participants de la partie

### 7. **Table `questions`**
```sql
CREATE TABLE questions (
  id text PRIMARY KEY,
  text text NOT NULL,
  game_type text NOT NULL,
  ambiance text NOT NULL,
  category text
);
```
- **Colonnes et connexions frontend**:
  - `id` ‚Üí ID unique de la question
  - `text` ‚Üí Texte affich√© (Game)
  - `game_type` ‚Üí 'kikadi', 'kidivrai', 'kidenous', 'kideja'
  - `ambiance` ‚Üí 'safe', 'intime', 'nofilter'
  - `category` ‚Üí Cat√©gorie optionnelle
- **√âl√©ments frontend connect√©s**:
  - Composants de mini-jeux
  - Hook `useGameQuestions`
- **RLS**: ‚úÖ Configur√© (lecture publique)

### 8. **Table `answers`**
```sql
CREATE TABLE answers (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  player_id uuid REFERENCES auth.users(id),
  round_id uuid REFERENCES rounds(id),
  content text NOT NULL,
  is_bluff boolean DEFAULT false,
  timestamp timestamp DEFAULT now()
);
```
- **Colonnes et connexions frontend**:
  - `id` ‚Üí ID unique de la r√©ponse
  - `player_id` ‚Üí Auteur de la r√©ponse
  - `round_id` ‚Üí Round concern√©
  - `content` ‚Üí Texte de la r√©ponse (Game)
  - `is_bluff` ‚Üí Marqueur bluff (gameplay)
  - `timestamp` ‚Üí Heure de soumission
- **√âl√©ments frontend connect√©s**:
  - Game : phase answer, affichage des r√©ponses
  - Hook `useGameAnswers`
- **RLS**: ‚úÖ Configur√©
  - Lecture : participants de la partie
  - √âcriture : auteur uniquement

### 9. **Table `votes`**
```sql
CREATE TABLE votes (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  player_id uuid REFERENCES auth.users(id),
  round_id uuid REFERENCES rounds(id),
  target_player_id uuid REFERENCES auth.users(id),
  answer_id uuid REFERENCES answers(id),
  vote_type text NOT NULL,
  timestamp timestamp DEFAULT now()
);
```
- **Colonnes et connexions frontend**:
  - `id` ‚Üí ID unique du vote
  - `player_id` ‚Üí Votant
  - `round_id` ‚Üí Round concern√©
  - `target_player_id` ‚Üí Joueur cibl√©
  - `answer_id` ‚Üí R√©ponse vot√©e
  - `vote_type` ‚Üí 'guess', 'bluff', 'truth'
  - `timestamp` ‚Üí Heure du vote
- **√âl√©ments frontend connect√©s**:
  - Game : phase vote, interface de vote
  - Hook `useGameVotes`
- **RLS**: ‚úÖ Configur√©
  - Lecture : participants de la partie
  - √âcriture : votant uniquement

---

## üèÜ Historique et r√©compenses

### 10. **Table `game_history`**
```sql
CREATE TABLE game_history (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  game_id uuid REFERENCES games(id),
  player_id uuid REFERENCES auth.users(id),
  final_score integer NOT NULL,
  final_position integer NOT NULL,
  coins_gained integer DEFAULT 0,
  xp_gained integer DEFAULT 0,
  completed_at timestamp DEFAULT now()
);
```
- **Colonnes et connexions frontend**:
  - `id` ‚Üí ID unique de l'historique
  - `game_id` ‚Üí Partie concern√©e
  - `player_id` ‚Üí Joueur concern√©
  - `final_score` ‚Üí Score final
  - `final_position` ‚Üí Position finale (1er, 2√®me, etc.)
  - `coins_gained` ‚Üí Coins gagn√©s
  - `xp_gained` ‚Üí XP gagn√©e
  - `completed_at` ‚Üí Date de fin
- **√âl√©ments frontend connect√©s**:
  - Dashboard : historique des parties
  - Game : √©cran de fin de partie
- **RLS**: ‚ùå √Ä configurer

### 11. **Table `shop_items`**
```sql
CREATE TABLE shop_items (
  id text PRIMARY KEY,
  name text NOT NULL,
  type text NOT NULL,
  emoji text,
  description text,
  price integer NOT NULL,
  rarity text DEFAULT 'common'
);
```
- **Colonnes et connexions frontend**:
  - `id` ‚Üí ID unique de l'item
  - `name` ‚Üí Nom affich√© (Shop)
  - `type` ‚Üí 'avatar', 'title', 'effect'
  - `emoji` ‚Üí Emoji/ic√¥ne
  - `description` ‚Üí Description (Shop)
  - `price` ‚Üí Prix en coins (Shop)
  - `rarity` ‚Üí Raret√© (couleur, tri)
- **√âl√©ments frontend connect√©s**:
  - Shop : catalogue d'items
- **RLS**: ‚ùå √Ä configurer (lecture publique)

### 12. **Table `user_purchases`**
```sql
CREATE TABLE user_purchases (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users(id),
  item_id text REFERENCES shop_items(id),
  price integer NOT NULL,
  purchased_at timestamp DEFAULT now()
);
```
- **Colonnes et connexions frontend**:
  - `id` ‚Üí ID unique de l'achat
  - `user_id` ‚Üí Acheteur
  - `item_id` ‚Üí Item achet√©
  - `price` ‚Üí Prix pay√©
  - `purchased_at` ‚Üí Date d'achat
- **√âl√©ments frontend connect√©s**:
  - Shop : items poss√©d√©s
  - Profile : items √©quip√©s
- **RLS**: ‚ùå √Ä configurer

### 13. **Table `achievements`**
```sql
CREATE TABLE achievements (
  id text PRIMARY KEY,
  name text NOT NULL,
  description text NOT NULL,
  emoji text,
  rarity text DEFAULT 'common'
);
```
- **Colonnes et connexions frontend**:
  - `id` ‚Üí ID unique de l'achievement
  - `name` ‚Üí Nom affich√©
  - `description` ‚Üí Description
  - `emoji` ‚Üí Emoji/ic√¥ne
  - `rarity` ‚Üí Raret√©
- **√âl√©ments frontend connect√©s**:
  - Dashboard : liste des achievements
  - Notifications : achievements d√©bloqu√©s
- **RLS**: ‚ùå √Ä configurer (lecture publique)

---

## üîê √âtat des politiques RLS

### ‚úÖ **Tables s√©curis√©es**:
- `game_players` ‚Üí Acc√®s propri√©taire uniquement
- `games` ‚Üí Lecture participants, √©criture h√¥te
- `profiles` ‚Üí Lecture publique, √©criture propri√©taire
- `user_stats` ‚Üí Acc√®s propri√©taire uniquement
- `rounds` ‚Üí Lecture participants
- `answers` ‚Üí Lecture participants, √©criture auteur
- `votes` ‚Üí Lecture participants, √©criture auteur

### ‚ùå **Tables √† s√©curiser**:
- `game_history` ‚Üí RLS √† impl√©menter
- `shop_items` ‚Üí Lecture publique √† configurer
- `user_purchases` ‚Üí Acc√®s propri√©taire uniquement
- `achievements` ‚Üí Lecture publique √† configurer

---

## üîÑ Fonctions et triggers

### ‚úÖ **Fonctions SECURITY DEFINER cr√©√©es**:
- `can_access_game_player(uuid)` ‚Üí V√©rification propri√©taire
- `can_access_game(uuid)` ‚Üí V√©rification participation
- `is_game_host(uuid)` ‚Üí V√©rification h√¥te

### ‚úÖ **Triggers configur√©s**:
- `handle_new_user()` ‚Üí Cr√©ation automatique du profil
- `handle_new_user_stats()` ‚Üí Cr√©ation automatique des stats

---

## üö® Points critiques

### 1. **RLS manquant**:
- Tables du shop et achievements
- Historique des parties

### 2. **Index √† optimiser**:
- `games.code` pour les recherches rapides
- `game_players(game_id, user_id)` composite
- `answers.round_id` et `votes.round_id`

### 3. **Contraintes manquantes**:
- Validation des types de vote
- Validation des phases de jeu
- Validation des statuts

---

## ‚úÖ Prochaines √©tapes

1. **Compl√©ter les politiques RLS** manquantes
2. **Ajouter les index** de performance
3. **Impl√©menter les contraintes** de validation
4. **Tester les permissions** sur chaque table
5. **Optimiser les requ√™tes** complexes
